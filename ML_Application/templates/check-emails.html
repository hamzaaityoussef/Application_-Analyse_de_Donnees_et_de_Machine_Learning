{% extends 'app/base.html' %}

{% block content %}

<style>
    .fixed-size {
        width: 550px;
        height: 300px;
        overflow-y: auto;
        margin-right: 10px;
    }
    .spacing-left-50 {
        margin-left: 40px;
    }
</style>

<div class="container">
    <h2 class="mb-7 text-5xl text-left font-medium text-gray-700 uppercase tracking-wider">Email Checker</h2>
    <div class="border-t-4 border-t-indigo-500 border-transparent ...">
        <br><br>
    </div>
    
    <form id="upload-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3 flex">
            {{ form.file.label_tag }}
            {{ form.file }}
            <br>
            <button type="button" id="upload-button" class="btn btn-primary">Upload</button>
        </div>
    </form>
    
    <!-- Editable area for displaying file content -->
    <div class="mt-5">
        <h3 class="text-3xl text-left font-medium text-gray-700 uppercase tracking-wider">File Content</h3>
        <div id="file-content" contenteditable="true" class="border p-4 fixed-size bg-white shadow-md rounded">
            <!-- Content of the uploaded file will be shown here -->
        </div>
        <br>
        <button type="button" id="test-button" class="btn btn-secondary mt-2">Test</button>
    </div>
    
    <div class="flex mt-5">
        <div>
            <h3 class="text-3xl text-left font-medium text-gray-700 uppercase tracking-wider">Emails Exist in Database</h3>
            <div id="exists" class="border p-3 fixed-size"></div>
            <button id="export-exists" class="btn btn-success mt-2">Export Exists</button>
        </div>
        
        <div class="spacing-left-50">
            <h3 class="text-3xl text-left font-medium text-gray-700 uppercase tracking-wider">Emails Not in Database</h3>
            <div id="not-exists" class="border p-3 fixed-size"></div>
            <button id="export-not-exists" class="btn btn-danger mt-2">Export Not Exists</button>
        </div>
    </div>
    
</div>

<script>
    // Handle file upload to display contents in editable div
   // Handle the upload button click
document.getElementById('upload-button').addEventListener('click', function(e) {
    e.preventDefault();
    const form = document.getElementById('upload-form');
    const formData = new FormData(form);
    
    // Fetch the file content to display in the editable div
const file = formData.get('file');
if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
        // Get the content from the file
        const fileContent = event.target.result;
        
        // Replace newline characters with <br> tags for display in the div
        const formattedContent = fileContent.replace(/\n/g, '<br>');

        // Display the formatted content in the editable div
        document.getElementById('file-content').innerHTML = formattedContent;
    };
    reader.readAsText(file);
}

}); 

document.getElementById('test-button').addEventListener('click', function() {
    // Extract content from the editable div and split by line breaks
    const fileContent = document.getElementById('file-content').innerText; // Use innerText to preserve line breaks
    const lines = fileContent.split(/\r?\n|\r|\n/g).map(line => line.trim()).filter(line => line); // Split by line breaks and filter empty lines

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Send the displayed content for testing against the database
    fetch('{% url "upload" %}', {
        method: 'POST',
        body: JSON.stringify({ 'file_content': lines }), // Send lines as an array
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => { throw new Error(JSON.stringify(errorData)) });
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            console.error('Error:', data.error);
            return;
        }

        const existsDiv = document.getElementById('exists');
        const notExistsDiv = document.getElementById('not-exists');

        existsDiv.innerHTML = '';
        notExistsDiv.innerHTML = '';

        data.exists.forEach(line => {
            const p = document.createElement('p');
            p.textContent = line.join(', '); // Join array to string if line is an array
            existsDiv.appendChild(p);
        });

        data.not_exists.forEach(line => {
            const p = document.createElement('p');
            p.textContent = line.join(', '); // Join array to string if line is an array
            notExistsDiv.appendChild(p);
        });
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
        alert(`Error: ${error.message}`);
    });
});





    document.getElementById('export-exists').addEventListener('click', function() {
        exportDivToCSV('exists', 'exists.csv');
    });

    document.getElementById('export-not-exists').addEventListener('click', function() {
        exportDivToCSV('not-exists', 'not_exists.csv');
    });

    function exportDivToCSV(divId, filename) {
        const rows = document.getElementById(divId).querySelectorAll('p');
        let csvContent = '';

        rows.forEach(row => {
            csvContent += row.textContent + '\n';
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', filename);
        link.click();
    }
</script>

{% endblock %}
