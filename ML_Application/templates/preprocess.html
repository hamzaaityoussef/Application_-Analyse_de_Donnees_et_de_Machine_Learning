{% extends 'base.html' %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Preprocessing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #001f3f;
            color: #ffffff;
        }
        h1, h3 {
            color: #ffffff;
        }
        /* Style for making the table scrollable */
        .table-container {
            max-height: 300px;
            max-width: 600px; /* Adjust the height as needed */
            overflow-y: auto;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center">Data Preprocessing</h1>
        <br>
        <!-- Dataset Selection -->
    <div class="mb-4">
        <label for="dataset-select" class="form-label">Select a Dataset</label>
        <form method="GET" action="{% url 'preprocess' %}">                                            
            <select id="dataset-select" name="dataset_id" class="form-select" onchange="this.form.submit()">
                <option value="">-- Select a Dataset --</option>
                {% for dataset in datasets %}
                    <option value="{{ dataset.id }}" {% if dataset.id == selected_dataset_id|default:'' %}selected{% endif %}>
                        {{ dataset.name }}
                    </option>
                {% endfor %}
            </select>
        </form>
    </div>

    {% if selected_dataset_id %}
    <div class="row">
        <div class="col-md-6 mb-4">
            <h3>First 10 Rows</h3>
            <div class="table-container">
                {{ head|safe }}
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <h3>Statistics</h3>
            <ul>
                <li><strong>Number of Rows:</strong> <span id="row-count">{{ row_count }}</span></li>
                <li><strong>Number of Features:</strong> <span id="feature-count">{{ feature_count }}</span></li>
                <li><strong>Missing Values:</strong> <pre id="missing-values">{{ missing_values }}</pre></li>
                <li><strong>Duplicate Rows:</strong> <span id="duplicate-rows">{{ duplicate_rows }}</span></li>
                <li><strong>Data Types:</strong> <pre id="data-types">{{ data_types }}</pre></li>
            </ul>
        </div>
    </div>
    {% endif %}

        <!-- Data Cleaning Modal -->
        <div id="data-cleaning-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 flex justify-center items-center bg-black bg-opacity-50"    >

            <div class="relative w-full max-w-md bg-white rounded-lg shadow-lg p-6" id="actionModal">
                <h3 class="text-center text-lg font-semibold" style="color: black;">Data Cleaning</h3>
                <form  id="data-cleaning-form" action="{% url 'apply_actions' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="clean_data" value="true">
                    <input type="hidden" id="dataset-id" name="dataset_id" value="{{ selected_dataset_id }}">

                    <div class="mb-3">
                        <label for="action" class="block" style="color: black;">Choose Action</label>
                        <select id="action" name="action" class="form-select">
                            <option value="" >Choose option</option>
                            <option value="fill" >Fill Nulls</option>
                            <option value="delete">Delete Nulls</option>
                            <option value="duplicated">Delete duplicated</option>
                        </select>
                    </div>

                    <div id="fill-method-container" class="mb-3 hidden">
                        <label for="fill-method" class="block" style="color: black;">Fill Method</label>
                        <select id="fill-method" name="fill_method" class="form-select">
                            <option value="">Choose option</option>
                            <option value="mean">Fill with Mean</option>
                            <option value="next">Fill with Next Value</option>
                            <option value="most_frequent">Fill with Most Frequent</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-full" id="action-trigger">Apply</button>
                </form>
                <button data-modal-toggle="data-cleaning-modal" class="btn btn-secondary w-full mt-3">Close</button>
            </div>
        </div>

        
        <!-- Data Transformation Modal -->
        <div id="data-transformation-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 flex justify-center items-center bg-black bg-opacity-50">
            <div class="relative w-full max-w-md bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-center text-lg font-semibold " style="color: black;">Data Transformation</h3>
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="transform_data" value="true">

                    <!-- Transformation Type Dropdown -->
                    <div class="mb-3">
                        <label for="transform_type" class="block" style="color: black;">Transformation Type</label>
                        <select id="transform_type" name="transform_type" class="form-select">
                            <option value="normalize">Normalize</option>
                            <option value="standardize">Standardize</option>
                        </select>
                    </div>

                    <!-- Feature Selection Checkbox -->
                    <div class="mb-3">
                        <label for="feature_selection" class="block" style="color: black;">Feature Selection</label>
                        <input type="checkbox" name="feature_selection" id="feature_selection" style="color: black;"> Use auto feature selection
                    </div>

                    <button type="submit" class="btn btn-primary w-full">Apply</button>
                </form>
                <button data-modal-toggle="data-transformation-modal" class="btn btn-secondary w-full mt-3">Close</button>
            </div>
        </div>

        <!-- Data Cleaning Button -->
        <button data-modal-toggle="data-cleaning-modal" class="btn btn-danger w-100">Data Cleaning</button>

        <!-- Data Transformation Button -->
        <button data-modal-toggle="data-transformation-modal" class="btn btn-warning w-100 mt-3">Data Transformation</button>


    </div>

    <script>
        // Show modal when button is clicked
        document.querySelectorAll('[data-modal-toggle]').forEach(button => {
        button.addEventListener('click', () => {
            const modalId = button.getAttribute('data-modal-toggle');
            const modal = document.getElementById(modalId);
            
            // Check if modal is currently hidden or visible, then toggle accordingly
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden'); // Show modal
            } else {
                modal.classList.add('hidden'); // Hide modal
            }
        });
    });

        // Show fill method select if "Fill Nulls" is selected
        document.getElementById('action').addEventListener('change', function() {
            if (this.value === 'fill') {
                document.getElementById('fill-method-container').classList.remove('hidden');
            } else {
                document.getElementById('fill-method-container').classList.add('hidden');
            }
        });
    </script>


<script>
$('#action-trigger').on('click', function (event) {
    event.preventDefault(); // Prevent form submission

    // Extract the action, dataset ID, and fill method
    const action = $('#action').val();
    const datasetId = $('#dataset-id').val();
    const fillMethod = $('#fill-method').val();

    // Prepare request data
    let requestData = {
        action: action,
        dataset_id: datasetId,
        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
    };

    if (action === 'fill') {
        requestData.fill_method = fillMethod;
    }

    // Send AJAX request
    $.ajax({
        url: '/apply_action/', // Ensure this matches the route in urls.py
        method: 'POST',
        data: requestData,
        success: function (response) {
            // Update HTML content dynamically
            $('.table-container').html(response.head);
            $('#row-count').text(response.row_count);
            $('#feature-count').text(response.feature_count);
            $('#missing-values').text(JSON.stringify(response.missing_values));
            $('#duplicate-rows').text(response.duplicate_rows);
            $('#data-types').text(JSON.stringify(response.data_types));

            

            // Hide the dataset dropdown after applying the action
            $('#data-cleaning-modal').addClass('hidden'); // Hides the entire div containing the dropdown
            
        },
        error: function (xhr) {
            alert('Error: ' + xhr.responseJSON.error);
        },
    });
});




</script>
</body>
</html>
{% endblock %}
